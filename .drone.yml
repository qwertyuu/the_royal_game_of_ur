kind: pipeline
type: docker
name: the_royal_game_of_ur

steps:
  - name: restore-cache-with-filesystem
    image: meltwater/drone-cache:v1.1
    settings:
      restore: true
      backend: "filesystem"
      cache_key: '{{ .Repo.Name }}_{{ checksum "composer.lock" }}_v1'
      archive_format: "gzip"
      mount:
        - 'vendor'
    volumes:
      - name: DroneIO-Cache
        path: /tmp/cache

  - name: rebuild-cache-with-filesystem
    image: meltwater/drone-cache:v1.1
    settings:
      rebuild: true
      backend: "filesystem"
      cache_key: '{{ .Repo.Name }}_{{ checksum "composer.lock" }}_v1'
      archive_format: "gzip"
      mount:
        - 'vendor'
    volumes:
      - name: DroneIO-Cache
        path: /tmp/cache

  - name: docker-latest
    when:
      branch:
        include:
          - master
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      repo: saaq.whnet.ca/qwertyuu/the_royal_game_of_ur
      cache_from: "saaq.whnet.ca/qwertyuu/the_royal_game_of_ur:latest"
      registry: saaq.whnet.ca
      tags:
        - latest

  - name: docker-staging
    when:
      branch:
        exclude:
          - master
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      repo: saaq.whnet.ca/qwertyuu/the_royal_game_of_ur
      cache_from: "saaq.whnet.ca/qwertyuu/the_royal_game_of_ur:latest-staging"
      registry: saaq.whnet.ca
      tags:
        - latest-staging

volumes:
  - name: DroneIO-Cache
    host:
      path: /var/lib/cache
